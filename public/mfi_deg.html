<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
        <title id="page_title"></title>
        <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
<!--        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">-->
<!--        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->
<!--        <link rel="stylesheet" href="css/cpdbviz.css">-->
<!--        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>-->
<!--        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.4/d3.min.js"></script>-->
<!--        <script type="text/javascript" src="https://unpkg.com/d3fc@15.2.6/build/d3fc.js"></script>-->
<!--        <script type="text/javascript" src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>-->
<!--        <script src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>-->
<!--        <script src="https://bundle.run/blob-stream@0.1.3"></script>-->
<!--        <script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>-->
<!--        <script src="./js/sankey.js" type="text/javascript"></script>-->
<!--        <script src="./js/cpdbviz.js" type="text/javascript"></script>-->

        <link rel="stylesheet" href="./external/css/material_icons.css" >
        <link rel="stylesheet" href="./external/css/materialize.min.css">
        <link rel="stylesheet" href="css/cpdbviz.css">
        <script type="text/javascript" src="./external/js/materialize.min.js"></script>
        <script type="text/javascript" src="./external/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="./external/js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="./external/js/d3.min.js"></script>
        <script type="text/javascript" src="./external/js/d3fc.js"></script>
        <script type="text/javascript" src="./external/js/d3-scale-chromatic.v3.min.js"></script>
        <script type="text/javascript" src="./external/js/raphael.min.js"></script>
        <script src="./js/sankey.js" type="text/javascript"></script>
        <script src="./js/cpdbviz.js" type="text/javascript"></script>
        <!-- Libraries below are needed to saving plots as PDFs    -->
        <script type="text/javascript" src="./external/js/pdfkit.standalone.js"></script>
        <script type="text/javascript" src="./external/js/blob-stream@0.1.3"></script>
        <script type="text/javascript" src="./external/js/source.js"></script>
  </head>
  <script type="module">
import generateCellCellInteractionSummaryChordPlot from "./js/chord.js";
const projectId = $("#project_id").text();
$.ajax({
    url: '/api/data/'+projectId+'/cell_cell_interaction_summary',
    contentType: "application/json",
    dataType: 'json',
    success: function(res) {
       if (res.hasOwnProperty('microenvironment2cell_types')) {
            const microenvironment2cell_types = res['microenvironment2cell_types'];
            const map = new Map(Object.entries(microenvironment2cell_types));
            if (map.size > 0) {
                var cnt = 1;
                for (let [microenvironment, cellTypes] of map.entries()) {
                    generateCellCellInteractionSummaryChordPlot(res, cellTypes.sort(), microenvironment, cnt);
                    cnt++;
                    if (cnt > 9) {
                        // TODO: We currently only have up to nine slots for microenvironment-specific cci plots - to be reviewed
                        break;
                    }
                }
                // Generate plot across cell types also - in case the user wishes to see it
                generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types'], "All cell types", 0);
            } else {
                generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types'], "All cell types", 0);
            }
        } else {
            generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types'], "All cell types", 0);
        }
    }
 });


</script>

  <body>
        <!-- base tag appears to be needed for page anchors to work correctly in ToC below-->
        <base target=_blank>
        <h4 class="center" id="page_header"></h4>
        <div class="col s12">
          <div class="row">
                <div class="card-content center">
                   <a href="#" data-target="toc-dropdown" style="text-transform: none;" class="dropdown-trigger btn">
                     Table of contents&nbsp;<i style="vertical-align: middle;" class="large material-icons center">format_list_bulleted</i>
                  </a>
                </div>
          </div>
        </div>

        <!-- Dropdown ToC -->
        <ul id='toc-dropdown' class='dropdown-content'>
             <div class="toc-header left">Input dataset: overview</div>
          <li id="toc_ctcomp"><a href="#ctcomp_title">Cell composition</a></li>
          <li><a href="#spme_title">Spatial microenvironments</a></li>
          <li><a href="#sge_title">Single gene expression</a></li>
          <li class="divider" tabindex="-1"></li>
             <div class="toc-header left">CellphoneDB predictions</div>
          <li><a href="#cci_summary_title">Cell-cell Communication - Summary</a></li>
          <li><a href="#cci_search_title">Cell-cell Communication - Search</a></li>
        </ul>

        <div id="project_id" hidden>mfi_deg</div>

        <div class="col s12">
          <div class="row">
            <!-- Celltype composition sankey plot -->
            <div>
              <div class="col s12 m6 l6">
                <div class="card">
                  <div class="card-content black-text col s12">
                    <span id="ctcomp_title" class="card card-title center">Cell composition</span>
                    <button id="ctcomp_save_button" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('ctcomp','ctcomp_title','ctcomp_header')">
                        <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                    </button>
                      <div id="ctcomp_header" hidden></div>
                      <div id="ctcomp" style="width:1200px;height:500px"></div>
                  </div>
                </div>
              </div>

            <!-- Spatial micro-environments plot -->
            <div>
              <div class="col s12 m6 l6">
                <div class="card">
                  <div class="card-content black-text col s12">
                    <span id="spme_title" class="card card-title center">Spatial microenvironments</span>
                    <button id="spme_save_button" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('spme','spme_title','spme_header')">
                        <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                    </button>
                    <div id="spme_header" hidden>Cell Type - Microenvironment</div>
                      <div id="spme" style="width:800px"></div>
                  </div>
                </div>
              </div>

            </div>
          </div> <!-- <div class="row"> -->
        </div> <!-- <div class="col s12"> -->

        <div class="col s12">
          <div class="card">
             <div class="card-content col s12">
                <span id="sge_title" class="card card-title center">Single gene expression</span>
              </div>
              <div class="row">
                 <div id="search_results" hidden>
                   <div class="card">
                     <div class="card-content black-text col s12">
                       <div id="search_results_table"  class="col s12">
                         <span id="search_results_title" class="card-title"></span>
                         <div hidden id="search_results_csv"></div>
                         <div class="divider"></div>
                           <span style="color: blue"><i>Click on an interaction partner name for more information.</i></span>
                         <p />
                       </div>
                     </div>
                   </div>
                 </div>

                  <div style="padding-left: 35px" class="col s12 m3 l3">
                    <div class="card blue-grey lighten-1">
                      <div  class="card-panel black-text col s12">
                        <div class="row">
                          <div class="col s12">
                            <div class="row">
                              <div style="padding-left: 20px; padding-right: 20px">
                                  <div class="section">
                                    <button id="refresh_sge_plot_btn" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="refreshSGEPlot()">Refresh plot
                                        <i class="material-icons right">refresh</i>
                                    </button>
                                    <div style="padding-top: 10px;"></div>
                                    <button id="clear_sge_filters" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="clearSGEFilters()">Clear filters&nbsp;
                                        <i class="material-icons right">clear_all</i>
                                    </button>
                                  </div>
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="sge_gene_input" placeholder="Gene name">
                                    <label style="padding-top: 30px;" for="sge_gene_input" class="black-text text-lighten-10">Add genes to the plot</label>
                                  </div>
                                  <div class="sge_selected_genes"></div>
                                  <div style="padding-top: 20px;"></div>
                                  <button id="sge_select_all_celltypes" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="selectAllCellTypes('single_gene_expression')">Select all cell types
                                      <i class="material-icons right">done_all</i>
                                  </button>
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="sge_celltype_input" placeholder="Cell type">
                                    <label style="padding-top: 30px;" for="sge_celltype_input" class="black-text text-lighten-10">Add cell types to the plot</label>
                                  </div>
                                  <div class="sge_selected_celltypes"></div>
                                  <div id="sge_microenvironment_sel" class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="sge_microenvironment_input" placeholder="Microenvironment">
                                    <label style="padding-top: 30px;" for="sge_microenvironment_input" class="black-text text-lighten-10">Filter by microenvironment</label>
                                  </div>
                                  <div class="sge_selected_microenvironments"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col s12 m9 l9 push-s1">
                    <div class="card">
                        <div class="card-content black-text col s12">
                          <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('sge','sge_title','sge_header')">
                             <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                          </button>
                          <div id="sge_header" hidden></div>
                            <div id="sge" style="width:1000px"></div>
                        </div>
                    </div>
                  </div>
              </div> <!-- <div class="row"> -->
          </div> <!-- <div class="card"> -->
        </div> <!-- <div class="col s12"> -->

        <div class="col s12">
          <div class="card">
              <div class="card-content col s12">
                <span id="cci_summary_title" class="card card-title center">Cell-cell Communication - Summary</span>
              </div>
              <div class="switch" style="padding-left: 30px;">
                <label>
                  <span class="black-text text-lighten-10">Show heatmaps</span>
                  <input id="cci_summary_switch" type="checkbox">
                  <span class="lever"></span>
                  <span class="black-text text-lighten-10">Show chord plots</span>
                </label>
              </div>
              <div id="cci_summary_show_all_celltypes_div" style="padding-top: 20px; padding-left: 30px;" hidden>
                  <label>
                      <input id="cci_summary_show_all_celltypes" type="checkbox" class="filled-in"/>
                      <span id="cci_summary_show_all_celltypes_label">Show all cell types</span>
                  </label>
              </div>
              <div class="row">
                <!-- Cell cell interaction plot - All cell types-->
                <div id="cci0_div" hidden>
                  <div class="col s12 m6 l6">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci0','cci_summary_title','cci0_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci0_header" hidden></div>
                          <div id="cci0" style="width:800px"></div>
                          <div id="cci0_chord" style="width:800px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 1 -->
                <div id="cci1_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci1','cci_summary_title','cci1_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci1_header" hidden></div>
                          <div id="cci1" style="width:400px"></div>
                          <div id="cci1_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 2 -->
                <div id="cci2_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci2','cci_summary_title','cci2_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci2_header" hidden></div>
                          <div id="cci2" style="width:400px"></div>
                          <div id="cci2_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 3 -->
                <div id="cci3_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci3','cci_summary_title','cci3_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci3_header" hidden></div>
                          <div id="cci3" style="width:400px"></div>
                          <div id="cci3_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- <div class="row"> -->

              <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 4 -->
                <div id="cci4_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci4','cci_summary_title','cci4_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci4_header" hidden></div>
                          <div id="cci4" style="width:400px"></div>
                          <div id="cci4_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 5 -->
                <div id="cci5_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci5','cci_summary_title','cci5_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci5_header" hidden></div>
                          <div id="cci5" style="width:400px"></div>
                          <div id="cci5_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 6 -->
                <div id="cci6_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci6','cci_summary_title','cci6_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci6_header" hidden></div>
                          <div id="cci6" style="width:400px"></div>
                          <div id="cci6_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- <div class="row"> -->
             <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 7 -->
                <div id="cci7_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci7','cci_summary_title','cci7_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci7_header" hidden></div>
                          <div id="cci7" style="width:400px"></div>
                          <div id="cci7_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 8 -->
                <div id="cci8_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci8','cci_summary_title','cci8_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci8_header" hidden></div>
                          <div id="cci8" style="width:400px"></div>
                          <div id="cci8_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 9 -->
                <div id="cci9_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci9','cci_summary_title','cci9_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                        <div id="cci9_header" hidden></div>
                          <div id="cci9" style="width:400px"></div>
                          <div id="cci9_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- <div class="row"> -->
            </div>  <!-- <div class="card"> -->
        </div> <!-- <div class="col s12"> -->

        <div class="col s12">
           <div style="padding-left: 30px; padding-right: 30px;" class="card">
                <div class="card-content col s12">
                  <span id="cci_search_title" class="card card-title center">Cell-cell Communication - Search</span>
<!--                      <span id="ccis_input_header" class="card-title center" style="font-size: 16px;">Placeholder/span>-->
                </div>
                <div class="card-panel">
                    <div class="row">
                        <!-- Cell-cell Interaction Search - Microenvironment/Cell type Inputs -->
                        <div id="ccis_input1_div">
                          <div class="col s12 m6 l6">
                            <div class="card">
                              <div class="card-content black-text col s12">
                                      <div id="cci_search_microenvironment_sel" class="input-field">
                                        <input style="padding-top: 30px;" type="text" id="cci_search_microenvironment_input" placeholder="Microenvironment">
                                        <label style="padding-top: 30px;" for="cci_search_microenvironment_input" class="black-text text-lighten-10">Filter by microenvironment</label>
                                      </div>
                                      <div class="cci_search_selected_microenvironments"></div>
                                        <button id="cci_search_select_all_celltypes" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="selectAllCellTypes('cell_cell_interaction_search')">Select all cell types
                                           <i class="material-icons right">done_all</i>
                                        </button>
                                      <div class="input-field">
                                        <input style="padding-top: 20px;" type="text" id="cci_search_celltype_input" placeholder="Cell type">
                                        <label style="padding-top: 20px;" for="cci_search_celltype_input" class="black-text text-lighten-10">Filter by cell types</label>
                                      </div>
                                      <div class="cci_search_selected_celltypes"></div>
                                      <div class="input-field">
                                        <input style="padding-top: 20px;" type="text" id="cci_search_celltype_pair_input" placeholder="Cell type pair">
                                        <label style="padding-top: 20px;" for="cci_search_celltype_pair_input" class="black-text text-lighten-10">Filter by cell type pairs</label>
                                      </div>
                                      <div class="cci_search_selected_celltype_pairs"></div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Cell-cell Interaction Search - Gene/Interaction Inputs -->
                        <div id="ccis_input2_div" style="padding-left: 20px;">
                          <div class="col s12 m6 l6">
                            <div class="card">
                              <div class="card-content black-text col s12">
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="cci_search_gene_input" placeholder="Gene">
                                    <label style="padding-top: 30px;" for="cci_search_gene_input" class="black-text text-lighten-10">Filter by genes</label>
                                  </div>
                                  <div class="cci_search_selected_genes"></div>
                                  <div class="input-field">
                                    <input style="padding-top: 20px;" type="text" id="cci_search_interaction_input" placeholder="Interaction">
                                    <label style="padding-top: 20px;" for="cci_search_interaction_input" class="black-text text-lighten-10">Filter by interactions</label>
                                  </div>
                                  <div class="cci_search_selected_interactions"></div>
                                  <div class="section">
                                    <button id="refresh_cci_search_plot_btn" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="refreshCCISearchPlot()">Refresh plot
                                        <i class="material-icons right">refresh</i>
                                    </button>
                                    <button id="clear_cci_search_filters" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="clearCCISearchFilters()">Clear filters
                                        <i class="material-icons right">clear_all</i>
                                    </button>
                                  </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div> <!-- <div class="row"> -->
                </div> <!-- <div class="card-panel">  -->
                <div class="col s12">
                  <div class="card">
                    <div class="card-content black-text col s12">
                      <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci_search','cci_search_title','cci_search_header')">
                           <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                      </button>
                      <div class="switch" style="padding-top: 20px;">
                        <label>
                          <span class="black-text text-lighten-10">Show mean expressions</span>
                          <input id="cci_search_switch" type="checkbox">
                          <span class="lever"></span>
                          <span class="black-text text-lighten-10">Show z-scores</span
                        </label>
                      </div>
                      <div id="cci_search_header" hidden></div>
                        <div id="cci_search" style="width:1400px"></div>
                    </div>
                  </div>
                </div>
<!--              </div> &lt;!&ndash; <div class="row"> &ndash;&gt;-->
          </div> <!-- <div class="card"> -->
        </div> <!-- <div class="col s12"> -->

  </body>
</html>
